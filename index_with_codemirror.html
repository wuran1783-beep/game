<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é€ƒç¦»Bugè¿·å®« â€” CodeMirror åŸå‹ï¼ˆå‡çº§ç‰ˆï¼‰</title>

<!-- CodeMirror 5 (ç¨³å®šã€è½»é‡) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/comment/comment.min.js"></script>

<!-- Skulpt -->
<script src="https://cdn.jsdelivr.net/npm/skulpt/dist/skulpt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/skulpt/dist/skulpt-stdlib.js"></script>

<style>
  :root{
    --bg:#071428; --panel:#071A1F; --accent:#6ee7b7; --muted:#98a9b3;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:linear-gradient(180deg,#031018,#071428);color:#e7f5f0}
  .wrap{display:grid;grid-template-columns:280px 1fr 420px;gap:14px;padding:18px;min-height:100vh}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
  h3{margin:6px 0;font-size:15px}
  .small{font-size:13px;color:var(--muted)}
  /* left */
  .left{display:flex;flex-direction:column;gap:10px}
  .profile{display:flex;gap:8px;align-items:center}
  input[name="username"]{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:#e7f5f0}
  button{background:var(--accent);border:none;color:#042018;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .level-list{margin-top:6px;display:flex;flex-direction:column;gap:8px;max-height:62vh;overflow:auto;padding-right:6px}
  .level-item{padding:10px;border-radius:8px;background:transparent;border:1px dashed rgba(255,255,255,0.03);cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .level-item.active{background:linear-gradient(90deg, rgba(110,231,183,0.06), rgba(110,231,183,0.02));border:1px solid rgba(110,231,183,0.12)}
  .badge{background:#062f28;padding:6px 10px;border-radius:999px;font-size:13px;color:var(--accent)}

  /* editor */
  .editor-title{display:flex;justify-content:space-between;align-items:center}
  .editor-wrap{height:520px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .controls{display:flex;gap:8px;margin-top:8px;align-items:center}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600;padding:8px 10px}
  .hint{background:#021826;padding:8px;border-radius:8px;color:var(--muted);font-size:13px;margin-top:6px}

  /* right */
  .canvas{height:320px;border-radius:10px;background:linear-gradient(180deg,#04202a,#02121a);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
  .player{width:48px;height:48px;background:linear-gradient(180deg,#ffd47a,#ffb84d);border-radius:10px;position:absolute;left:28px;bottom:28px;display:flex;align-items:center;justify-content:center;color:#052018;font-weight:900;transition:transform 700ms cubic-bezier(.2,.9,.3,1)}
  .door{width:76px;height:120px;background:linear-gradient(180deg,#0c7a63,#05503f);position:absolute;right:40px;bottom:18px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:900;filter:grayscale(40%) brightness(0.85)}
  .door.unlocked{filter:none;box-shadow:0 8px 18px rgba(0,0,0,0.4)}
  .output{background:#021b24;padding:10px;border-radius:8px;min-height:120px;color:#bfeee0;font-family:monospace;white-space:pre-wrap;overflow:auto;border:1px solid rgba(255,255,255,0.02);margin-top:10px}
  .result-row{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .sticker{position:absolute;top:12px;left:12px;font-size:26px;pointer-events:none}
  .editor-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;color:var(--muted)}
  .editor-meta{display:flex;gap:8px;align-items:center}
  .editor-note{font-size:13px;color:var(--muted)}
  /* level editor modal-ish */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:880px;max-width:96%;z-index:999;padding:12px;border-radius:12px}
  .hidden{display:none}
  textarea.full{width:100%;height:180px;border-radius:8px;background:#02121a;border:1px solid rgba(255,255,255,0.03);color:#e7f5f0;padding:8px;font-family:monospace}
  .row{display:flex;gap:8px}
  label.small{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
</style>
</head>
<body>
<div style="padding:12px 18px 0 18px">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="font-weight:800;font-size:18px">é€ƒç¦»Bugè¿·å®« Â· CodeMirror åŸå‹</div>
      <div class="small" style="margin-left:8px">æ•™å­¦ç‰ˆï¼ˆå«æµ‹è¯•å¥—ä»¶ã€å…³å¡ç¼–è¾‘å™¨ã€æœ¬åœ°å­˜æ¡£ï¼‰</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="openLevelEditor" class="ghost">å…³å¡ç¼–è¾‘å™¨</button>
      <button id="clearStorage" class="ghost">æ¸…é™¤æœ¬åœ°è¿›åº¦</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- LEFT -->
  <div class="panel left">
    <div style="display:flex;flex-direction:column;gap:8px">
      <h3>ç”¨æˆ· & å­˜æ¡£</h3>
      <div class="profile">
        <input id="username" name="username" placeholder="è¾“å…¥ç”¨æˆ·åï¼ˆæœ¬åœ°ï¼‰" />
        <button id="saveUser">ç™»å½•/ä¿å­˜</button>
      </div>
      <div class="small" id="userInfo">æœªç™»å½•</div>
    </div>

    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
      <h3>å…³å¡åˆ—è¡¨</h3>
      <div class="small" id="progressInfo">0 / 0</div>
    </div>

    <div id="levelList" class="level-list"></div>

    <div style="margin-top:auto">
      <div class="small">Tipsï¼šè€å¸ˆå¯åœ¨å…³å¡ç¼–è¾‘å™¨ä¸­å¯¼å‡º JSONï¼Œå­¦ç”Ÿå¯¼å…¥å³å¯å¼€å§‹è¯¾ç¨‹ã€‚</div>
    </div>
  </div>

  <!-- MIDDLE: Editor -->
  <div class="panel" style="display:flex;flex-direction:column">
    <div class="editor-title">
      <div>
        <h3 id="levelTitle">è¯·é€‰æ‹©å…³å¡</h3>
        <div class="small" id="levelDesc">å…³å¡æè¿°</div>
      </div>
      <div class="editor-meta">
        <div class="badge" id="levelBadge">â€”</div>
      </div>
    </div>

    <div class="editor-wrap" id="editorWrap"></div>

    <div class="controls">
      <button id="runBtn">è¿è¡Œ â–¶ (Ctrl/Cmd+Enter)</button>
      <button id="hintBtn" class="ghost">æç¤º</button>
      <button id="resetBtn" class="ghost">å¤ä½</button>
      <div style="flex:1"></div>
      <div class="editor-note small">å¯åˆ‡æ¢ä¸ºè€å¸ˆæ¨¡å¼ç¼–è¾‘å…³å¡ â†’ ç‚¹å‡»ã€Œå…³å¡ç¼–è¾‘å™¨ã€</div>
    </div>

    <div id="hintBox" class="hint hidden"></div>
    <div class="editor-footer">
      <div class="small" id="lastRun">æœªè¿è¡Œ</div>
      <div class="small" id="editorHelp">æŒ‰ Tab æ’å…¥ç¼©è¿›</div>
    </div>
  </div>

  <!-- RIGHT: Canvas & output -->
  <div class="panel">
    <h3>æ¼”ç¤ºåŒº & è¾“å‡º</h3>
    <div class="canvas" id="canvas">
      <div class="sticker" id="stickerArea"></div>
      <div class="player" id="player">U</div>
      <div class="door" id="door">é—¨</div>
    </div>

    <div class="result-row">
      <div class="small">æ§åˆ¶å°è¾“å‡º</div>
      <div class="small">ç›®æ ‡ï¼š<span id="goalLabel">â€”</span></div>
    </div>

    <div id="output" class="output"></div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="importLevels" class="ghost">å¯¼å…¥å…³å¡ JSON</button>
      <button id="exportProgress" class="ghost">å¯¼å‡ºè¿›åº¦ï¼ˆJSONï¼‰</button>
    </div>
  </div>
</div>

<!-- å…³å¡ç¼–è¾‘å™¨æ¨¡æ€ -->
<div id="levelEditorModal" class="modal panel hidden" style="max-height:82vh;overflow:auto">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>å…³å¡ç¼–è¾‘å™¨ï¼ˆè€å¸ˆï¼‰</h3>
    <div style="display:flex;gap:8px">
      <button id="addLevel">æ–°å¢å…³å¡</button>
      <button id="closeEditor" class="ghost">å…³é—­</button>
    </div>
  </div>

  <div style="margin-top:8px">
    <div style="display:flex;gap:8px">
      <div style="flex:1">
        <label class="small">å…³å¡æ ‡é¢˜</label>
        <input id="editTitle" style="width:100%;padding:8px;border-radius:8px;background:#02121a;border:1px solid rgba(255,255,255,0.03);color:#e7f5f0" />
      </div>
      <div style="width:160px">
        <label class="small">å¾½ç« </label>
        <input id="editBadge" style="width:100%;padding:8px;border-radius:8px;background:#02121a;border:1px solid rgba(255,255,255,0.03);color:#e7f5f0" />
      </div>
    </div>

    <div style="margin-top:8px">
      <label class="small">ç®€çŸ­æè¿°</label>
      <input id="editDesc" style="width:100%;padding:8px;border-radius:8px;background:#02121a;border:1px solid rgba(255,255,255,0.03);color:#e7f5f0" />
    </div>

    <div style="margin-top:8px">
      <label class="small">èµ·å§‹ä»£ç ï¼ˆstarterï¼‰</label>
      <textarea id="editStarter" class="full"></textarea>
    </div>

    <div style="margin-top:8px">
      <label class="small">æµ‹è¯•ä»£ç ï¼ˆtestsï¼‰ â€” è¿è¡Œåœ¨ç©å®¶ä»£ç åï¼ˆå¯ä½¿ç”¨ assert æˆ–æ‰“å°ç‰¹å®š PASS/FAILï¼‰</label>
      <textarea id="editTests" class="full"># ç¤ºä¾‹ï¼šæ£€æŸ¥è¾“å‡ºå˜é‡æˆ–æ‰“å° PASS
# ä¾‹å¦‚ï¼š
# assert result == 42, "result should be 42"
# æˆ–è€…
# print("TEST:PASS")</textarea>
      <div class="small" style="margin-top:6px">æç¤ºï¼šæµ‹è¯•ä»£ç å¯ä»¥ä½¿ç”¨ assertï¼›æˆ–æ‰“å°æ ¼å¼ä¸º TEST:PASS / TEST:FAIL:msg ä¾›å‰ç«¯è§£æã€‚</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="saveLevel">ä¿å­˜å½“å‰å…³å¡</button>
      <button id="deleteLevel" class="ghost">åˆ é™¤å½“å‰å…³å¡</button>
      <button id="exportLevels" class="ghost">å¯¼å‡ºå…¨éƒ¨å…³å¡ JSON</button>
      <input id="importFile" type="file" accept=".json" style="display:none" />
    </div>
  </div>

  <div style="margin-top:12px">
    <label class="small">é¢„è§ˆï¼ˆå°†æŠŠ starter ä¸ tests åˆå¹¶è¿è¡Œï¼›ä¸ä¼šä¿å­˜ï¼‰</label>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button id="previewRun">é¢„è§ˆè¿è¡Œ</button>
      <button id="previewReset" class="ghost">é‡ç½®é¢„è§ˆ</button>
    </div>
    <div id="previewOutput" class="output" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ====== ç®€å•å†…ç½®èµ„æºï¼šéŸ³æ•ˆï¼ˆWebAudioï¼‰ ====== */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = AudioCtx ? new AudioCtx() : null;

function playTone(freq=440, duration=0.12, type='sine'){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  o.connect(g);
  g.connect(audioCtx.destination);
  g.gain.value = 0.0001;
  o.start();
  g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
  o.stop(audioCtx.currentTime + duration + 0.02);
}
function playSuccessSound(){
  playTone(880,0.09,'sine');
  setTimeout(()=>playTone(660,0.12,'sine'),90);
}
function playFailSound(){
  playTone(220,0.18,'square');
}

/* ====== åŸºç¡€å…³å¡æ•°æ®ï¼ˆå¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­ä¿®æ”¹/å¯¼å…¥/å¯¼å‡ºï¼‰ ====== */
let levels = [
  {
    id: 'l1-print',
    title: 'ä¼šè¯´è¯çš„çŸ³ç¢‘',
    desc: 'å­¦ä¼šä½¿ç”¨ print() è¾“å‡ºæ–‡å­—ï¼Œæ¿€æ´»çŸ³ç¢‘ã€‚',
    starter: '# TODO: æŠŠç¥·æ–‡æ‰“å°å‡ºæ¥ï¼Œå¯åŠ¨çŸ³ç¢‘\n\n',
    tests: `# æµ‹è¯•ï¼šæœŸå¾…æ§åˆ¶å°åŒ…å« Welcome to the Bug Maze!\n# æˆ‘ä»¬é€šè¿‡è¯»å–å˜é‡ _output æ•è· stdoutï¼ˆç”±å‰ç«¯æ³¨å…¥ï¼‰ï¼Œä¹Ÿå¯ç›´æ¥æ£€æŸ¥æ‰“å°\nif "Welcome to the Bug Maze!" not in _output:\n    raise AssertionError("è¯·è¾“å‡º Welcome to the Bug Maze!")\nprint("TEST:PASS")`,
    badge: 'Print åŸºç¡€'
  },
  {
    id: 'l2-if',
    title: 'çœŸå‡ä¹‹é—¨',
    desc: 'æ ¹æ®å¸ƒå°”å˜é‡æ‰“å¼€æ­£ç¡®çš„é—¨ï¼ˆè¾“å‡º "Open right door"ï¼‰ã€‚',
    starter: 'should_open_right_door = True\n\n# TODO: æ ¹æ® should_open_right_door è¾“å‡º "Open right door" æˆ– "Stay here"\n',
    tests: `if "Open right door" not in _output:\n    raise AssertionError('è¯·è¾“å‡º "Open right door"')\nprint("TEST:PASS")`,
    badge: 'If åˆ¤æ–­'
  },
  {
    id: 'l3-for',
    title: 'é™·é˜±èµ°å»Š',
    desc: 'éå†åœ°ç –åˆ—è¡¨ï¼Œé‡åˆ° trap æç¤º "Watch out!"ï¼Œå¦åˆ™ "Step forward"ã€‚',
    starter: 'tiles = ["safe", "trap", "safe", "safe", "trap"]\n\n# TODO: éå† tiles å¹¶åœ¨æ¯å—ç –ä¸Šæ‰“å°æç¤º\n',
    tests: `expected=["Step forward","Watch out!","Step forward","Step forward","Watch out!"]\nlines=[l.strip() for l in _output.splitlines() if l.strip()]\n# ç¡®ä¿åŒ…å« expected çš„é¡ºåº\nfor e in expected:\n    if e not in lines:\n        raise AssertionError("ç¼ºå°‘: "+e)\nprint("TEST:PASS")`,
    badge: 'Loop å·¥ç¨‹å¸ˆ'
  },
  {
    id: 'l4-func',
    title: 'ä¿®ç†æœºå™¨äºº',
    desc: 'å®šä¹‰ä¸€ä¸ª repair() å‡½æ•°ï¼ŒæŒ‰é¡ºåºæ‰“å°ä¸‰è¡Œï¼šScan / Fix / Testï¼Œç„¶åè°ƒç”¨å®ƒã€‚',
    starter: '# TODO: å®šä¹‰å¹¶è°ƒç”¨ repair()\n\n',
    tests: `lines=[l.strip() for l in _output.splitlines() if l.strip()]\nif lines[-3:] != ['Scan','Fix','Test']:\n    raise AssertionError('è¯·æŒ‰é¡ºåºæ‰“å°: Scan, Fix, Test')\nprint('TEST:PASS')`,
    badge: 'å‡½æ•°åŒ äºº'
  }
];

/* ====== çŠ¶æ€ & å­˜å‚¨ (per user) ====== */
let state = {
  currentLevelId: null,
  user: null,
  progress: {} // id -> {passed:true,t:ts}
};

const STORAGE_PREFIX = 'bugmaze_v1_';

function saveStateToLocal(){
  if(!state.user) return;
  const key = STORAGE_PREFIX + 'user_' + state.user;
  localStorage.setItem(key, JSON.stringify({progress: state.progress}));
}
function loadStateFromLocal(user){
  const key = STORAGE_PREFIX + 'user_' + user;
  const raw = localStorage.getItem(key);
  if(!raw) return {progress:{}};
  try{ return JSON.parse(raw); }catch(e){return {progress:{}};}
}

/* ====== DOM refs ====== */
const usernameEl = document.getElementById('username');
const saveUserBtn = document.getElementById('saveUser');
const userInfoEl = document.getElementById('userInfo');
const levelListEl = document.getElementById('levelList');
const progressInfoEl = document.getElementById('progressInfo');

const levelTitleEl = document.getElementById('levelTitle');
const levelDescEl = document.getElementById('levelDesc');
const levelBadgeEl = document.getElementById('levelBadge');

const runBtn = document.getElementById('runBtn');
const hintBtn = document.getElementById('hintBtn');
const resetBtn = document.getElementById('resetBtn');
const hintBox = document.getElementById('hintBox');
const lastRunEl = document.getElementById('lastRun');

const outputEl = document.getElementById('output');
const goalLabel = document.getElementById('goalLabel');
const playerEl = document.getElementById('player');
const doorEl = document.getElementById('door');
const stickerArea = document.getElementById('stickerArea');

const openLevelEditorBtn = document.getElementById('openLevelEditor');
const levelEditorModal = document.getElementById('levelEditorModal');
const closeEditorBtn = document.getElementById('closeEditor');
const addLevelBtn = document.getElementById('addLevel');
const editTitle = document.getElementById('editTitle');
const editDesc = document.getElementById('editDesc');
const editStarter = document.getElementById('editStarter');
const editTests = document.getElementById('editTests');
const editBadge = document.getElementById('editBadge');
const saveLevelBtn = document.getElementById('saveLevel');
const deleteLevelBtn = document.getElementById('deleteLevel');
const exportLevelsBtn = document.getElementById('exportLevels');
const importFileInput = document.getElementById('importFile');
const previewRunBtn = document.getElementById('previewRun');
const previewOutputEl = document.getElementById('previewOutput');
const previewResetBtn = document.getElementById('previewReset');
const importLevelsBtn = document.getElementById('importLevels');
const exportProgressBtn = document.getElementById('exportProgress');
const clearStorageBtn = document.getElementById('clearStorage');

/* ====== ç¼–è¾‘å™¨ï¼ˆCodeMirrorï¼‰åˆå§‹åŒ– ====== */
let editor = null;
function initEditor(){
  const wrap = document.getElementById('editorWrap');
  // create textarea placeholder
  wrap.innerHTML = '<textarea id="cm" style="height:100%"></textarea>';
  const ta = document.getElementById('cm');
  editor = CodeMirror.fromTextArea(ta, {
    mode: 'python',
    theme: 'dracula',
    lineNumbers: true,
    matchBrackets: true,
    indentUnit: 4,
    tabSize: 4,
    autofocus: true,
    extraKeys: {"Tab": cm => cm.replaceSelection("    "), "Ctrl-/": "toggleComment"},
  });
  editor.setSize("100%", "520");
  // run on ctrl/cmd+enter
  editor.addKeyMap({
    "Ctrl-Enter": () => runCurrent(),
    "Cmd-Enter": () => runCurrent()
  });
}

/* ====== UI æ¸²æŸ“ ====== */
function renderLevelList(){
  levelListEl.innerHTML = '';
  levels.forEach(l=>{
    const d = document.createElement('div');
    d.className = 'level-item' + (state.currentLevelId===l.id ? ' active':'');
    d.innerHTML = `<div style="display:flex;flex-direction:column">
      <div style="font-weight:700">${escapeHtml(l.title)}</div>
      <div class="small" style="margin-top:6px">${escapeHtml(l.desc)}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end">
      <div class="small">${l.badge||''}</div>
      <div style="height:8px"></div>
      <div class="small">${state.progress[l.id] && state.progress[l.id].passed ? 'âœ“' : ''}</div>
    </div>`;
    d.onclick = ()=>loadLevel(l.id);
    levelListEl.appendChild(d);
  });
  progressInfoEl.textContent = `${Object.values(state.progress).filter(p=>p && p.passed).length} / ${levels.length}`;
}

function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function loadLevel(id){
  const lvl = levels.find(x=>x.id===id);
  if(!lvl) return;
  state.currentLevelId = id;
  levelTitleEl.textContent = lvl.title;
  levelDescEl.textContent = lvl.desc;
  levelBadgeEl.textContent = lvl.badge || 'ä»»åŠ¡';
  editor.setValue(lvl.starter || '');
  hintBox.classList.add('hidden');
  outputEl.textContent = '';
  goalLabel.textContent = 'ä»¥æµ‹è¯•å¥—ä»¶ä¸ºå‡†';
  // reset visuals
  playerEl.style.transform = 'translateX(0)';
  doorEl.classList.remove('unlocked');
  stickerArea.textContent = '';
  renderLevelList();
  lastRunEl.textContent = 'å°šæœªè¿è¡Œ';
}

/* ====== Skulpt è¿è¡Œ + æµ‹è¯•å¥—ä»¶é›†æˆ ====== */
/*
  è¿è¡Œç­–ç•¥ï¼š
  - æˆ‘ä»¬åœ¨å‰ç«¯æ³¨å…¥ä¸€ä¸ªç‰¹æ®Šå˜é‡ `_output_capture`ï¼ˆä¸€ä¸ª listï¼‰å¹¶åœ¨ Python ç«¯æ”¶é›† print åˆ°å®ƒã€‚
  - æˆ–è€…æ›´ç®€å•ï¼šSkulpt çš„ output å›è°ƒ (outf) ä¼šæ•è·æ‰€æœ‰ stdout åˆ° JSï¼Œæˆ‘ä»¬åœ¨è¿è¡Œæµ‹è¯•æ—¶æŠŠè¯¥è¾“å‡ºæ³¨å…¥ä¸ºå˜é‡ `_output` ä¾› tests ä½¿ç”¨ã€‚
  - è¿è¡Œé¡ºåºï¼šå…ˆè¿è¡Œç”¨æˆ·ä»£ç ï¼ˆç”¨æˆ·ç¼–è¾‘åŒºå†…å®¹ï¼‰ï¼Œæ”¶é›†è¾“å‡ºï¼›ç„¶åè¿è¡Œæµ‹è¯•ä»£ç ï¼ˆlevel.testsï¼‰ä½†åœ¨è¯¥æµ‹è¯•ç¯å¢ƒä¸­æ³¨å…¥ `_output` å˜é‡ã€‚
  - tests é€šè¿‡ assert æˆ–æ‰“å° "TEST:PASS" / "TEST:FAIL:msg" æ¥è¡¨æ˜ç»“æœã€‚å‰ç«¯è§£æå¹¶æ˜¾ç¤ºã€‚
*/
function outf(text){
  outputEl.textContent += text;
}
function builtinRead(x){
  if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
      throw "File not found: '" + x + "'";
  return Sk.builtinFiles["files"][x];
}
async function runSkulpt(code){
  outputEl.textContent = '';
  lastRunEl.textContent = 'è¿è¡Œä¸­...';
  try{
    Sk.configure({output:outf, read:builtinRead});
    await Sk.misceval.asyncToPromise(function() {
      return Sk.importMainWithBody("<stdin>", false, code, true);
    });
    lastRunEl.textContent = 'è¿è¡Œç»“æŸ';
    return {ok:true, output: outputEl.textContent};
  }catch(e){
    lastRunEl.textContent = 'è¿è¡Œé”™è¯¯';
    outputEl.textContent += '\n[Error] ' + e.toString();
    return {ok:false, output: outputEl.textContent, error: e.toString()};
  }
}

// è¿è¡Œå½“å‰å…³å¡ï¼ˆç”¨æˆ·ä»£ç  + æµ‹è¯•ï¼‰
async function runCurrent(){
  const lvl = levels.find(x=>x.id===state.currentLevelId);
  if(!lvl){ alert('è¯·å…ˆé€‰æ‹©å…³å¡'); return; }
  // resume audio context on user gesture (some browsers require this)
  if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

  // 1) è¿è¡Œç”¨æˆ·ä»£ç å¹¶æ•è· stdout
  outputEl.textContent = '';
  const userCode = editor.getValue();
  // run user code in skulpt
  const runRes = await runSkulpt(userCode);
  const userOutput = runRes.output || '';
  // 2) è¿è¡Œæµ‹è¯•ä»£ç ï¼ˆåœ¨åŒä¸€ç¯å¢ƒä¼šæ±¡æŸ“å‘½åç©ºé—´; æˆ‘ä»¬åœ¨å…¨æ–° run ä¸­æŠŠ _output æ³¨å…¥ä¸ºå­—ç¬¦ä¸²å˜é‡ï¼‰
  // Build a wrapper test script that defines _output variable (string) and executes tests
  const testsScript = `_output = """${escapeForTriple(userOutput)}"""\n` + (lvl.tests || '');
  // Run tests
  const testRes = await runSkulpt(testsScript);
  const testOut = testRes.output || '';
  // parse test outputs
  const parsed = parseTestOutput(testOut);
  if(parsed.passed){
    // mark progress
    state.progress[lvl.id] = {passed:true, at: Date.now()};
    saveStateToLocal();
    renderLevelList();
    // animate success
    playSuccessSound();
    playSuccessAnim();
    outputEl.textContent += '\n\nğŸ‰ å…³å¡é€šè¿‡ï¼';
    stickerArea.textContent = 'ğŸ†';
    setTimeout(()=>stickerArea.textContent = '', 3000);
  }else{
    playFailSound();
    playFailAnim();
    outputEl.textContent += `\n\nâš ï¸ æµ‹è¯•æœªé€šè¿‡ï¼š${parsed.message || 'è¯·æ£€æŸ¥è¾“å‡º/æ–­è¨€'}`;
  }
}

// helper: escape triple-quoted string content
function escapeForTriple(s){
  if(!s) return '';
  return s.replace(/\\/g,'\\\\').replace(/"""/g,'\\"""');
}

// è§£ææµ‹è¯•è¾“å‡ºï¼ˆä¾èµ– tests ä½¿ç”¨ print("TEST:PASS") æˆ– æŠ›å‡º AssertionErrorï¼‰
function parseTestOutput(out){
  // If tests used print("TEST:PASS"), detect it
  const lines = out.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  for(const l of lines){
    if(l.startsWith('TEST:PASS')) return {passed:true};
    if(l.startsWith('TEST:FAIL')) {
      const m = l.split(':').slice(2).join(':') || 'å¤±è´¥';
      return {passed:false, message: m};
    }
  }
  // If there is "AssertionError" in output -> fail
  const joined = out;
  if(joined.indexOf('AssertionError')>=0 || joined.indexOf('[Error]')>=0){
    // try to extract message
    const m = joined.split(/AssertionError:?\s*/).slice(1).join('').split(/\n/)[0];
    return {passed:false, message: m || 'AssertionError'};
  }
  // fallback: if tests output nothing but we ran and no errors, assume pass
  if(out && out.indexOf('Traceback')<0 && out.indexOf('Error')<0) return {passed:true};
  return {passed:false, message: 'æœªçŸ¥æµ‹è¯•å¤±è´¥'};
}

/* ====== ç®€å•åŠ¨ç”» ====== */
function playSuccessAnim(){
  playerEl.style.transform = 'translateX(220px) translateY(0)';
  setTimeout(()=>doorEl.classList.add('unlocked'), 700);
}
function playFailAnim(){
  playerEl.style.transform = 'translateX(24px) translateY(0) scale(1.02)';
  setTimeout(()=>playerEl.style.transform = 'translateX(0) scale(1)', 300);
}

/* ====== Hint / Reset handlers ====== */
hintBtn.onclick = ()=>{
  const lvl = levels.find(x=>x.id===state.currentLevelId);
  if(!lvl) return;
  hintBox.textContent = (lvl.hint || 'æç¤ºï¼šé˜…è¯»å…³å¡æè¿°ï¼Œæ£€æŸ¥è¾“å‡ºæˆ–è¯­æ³•ã€‚');
  hintBox.classList.remove('hidden');
};
resetBtn.onclick = ()=>{
  const lvl = levels.find(x=>x.id===state.currentLevelId);
  if(!lvl) return;
  editor.setValue(lvl.starter || '');
  outputEl.textContent = '';
  hintBox.classList.add('hidden');
  lastRunEl.textContent = 'å·²é‡ç½®';
};

/* ====== User & persistence ====== */
saveUserBtn.onclick = ()=>{
  const name = (usernameEl.value||'').trim();
  if(!name){ alert('è¯·è¾“å…¥ç”¨æˆ·å'); return; }
  state.user = name;
  // load progress
  const loaded = loadStateFromLocal(name);
  state.progress = loaded.progress || {};
  userInfoEl.textContent = `å·²ç™»å½•ï¼š${name}`;
  saveStateToLocal(); // ensure key exists
  renderLevelList();
};
clearStorageBtn.onclick = ()=>{
  if(!confirm('å°†æ¸…é™¤æœ¬åœ°æ‰€æœ‰ Bug Maze å­˜æ¡£ï¼ˆæ‰€æœ‰ç”¨æˆ·ï¼‰ï¼Ÿ')) return;
  // remove keys with prefix
  Object.keys(localStorage).forEach(k=>{ if(k.startsWith(STORAGE_PREFIX)) localStorage.removeItem(k); });
  alert('å·²æ¸…é™¤');
  // reload page to reset state
  location.reload();
};

/* ====== Level editor æ“ä½œ ====== */
openLevelEditorBtn.onclick = ()=>{ openEditorModal(); };
closeEditorBtn.onclick = ()=>{ closeEditorModal(); };
addLevelBtn.onclick = ()=>{
  const newId = 'lvl_' + Date.now().toString(36);
  const newLvl = {id:newId, title:'æ–°å…³å¡', desc:'æè¿°', starter:'# starter', tests:'# tests', badge:'è‡ªå®šä¹‰'};
  levels.push(newLvl);
  loadLevel(newId);
  populateEditorFields(newLvl);
  renderLevelList();
};
function openEditorModal(){
  levelEditorModal.classList.remove('hidden');
  // if currentLevel selected, load into editor fields
  const lvl = levels.find(x=>x.id===state.currentLevelId) || levels[0];
  if(lvl) populateEditorFields(lvl);
}
function closeEditorModal(){
  levelEditorModal.classList.add('hidden');
}
function populateEditorFields(lvl){
  editTitle.value = lvl.title || '';
  editDesc.value = lvl.desc || '';
  editStarter.value = lvl.starter || '';
  editTests.value = lvl.tests || '';
  editBadge.value = lvl.badge || '';
}

saveLevelBtn.onclick = ()=>{
  if(!state.currentLevelId){ alert('è¯·å…ˆåœ¨ä¸»ç•Œé¢é€‰æ‹©ä¸€ä¸ªè¦ç¼–è¾‘çš„å…³å¡ï¼ˆæˆ–æ–°å¢ï¼‰'); return; }
  const lvl = levels.find(x=>x.id===state.currentLevelId);
  if(!lvl) return;
  lvl.title = editTitle.value;
  lvl.desc = editDesc.value;
  lvl.starter = editStarter.value;
  lvl.tests = editTests.value;
  lvl.badge = editBadge.value;
  alert('å·²ä¿å­˜å…³å¡ï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼‰ã€‚å¦‚éœ€é•¿æœŸä¿å­˜ï¼Œè¯·ç‚¹å‡» "å¯¼å‡ºå…¨éƒ¨å…³å¡ JSON"');
  renderLevelList();
};

deleteLevelBtn.onclick = ()=>{
  if(!state.currentLevelId) return;
  if(!confirm('è¦åˆ é™¤è¯¥å…³å¡ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ˆä»…æœ¬åœ°ï¼‰')) return;
  const idx = levels.findIndex(x=>x.id===state.currentLevelId);
  if(idx>=0) levels.splice(idx,1);
  state.currentLevelId = levels[0] ? levels[0].id : null;
  if(state.currentLevelId) loadLevel(state.currentLevelId);
  renderLevelList();
};

exportLevelsBtn.onclick = ()=>{
  const blob = new Blob([JSON.stringify(levels, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='bugmaze_levels.json'; a.click();
  URL.revokeObjectURL(url);
};

importLevelsBtn.onclick = ()=>{
  importFileInput.click();
};
importFileInput.onchange = (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const imported = JSON.parse(ev.target.result);
      if(Array.isArray(imported)){
        // append imported
        imported.forEach(item=>{
          // ensure id
          if(!item.id) item.id = 'imp_' + Date.now().toString(36);
          levels.push(item);
        });
        alert('å·²å¯¼å…¥ ' + imported.length + ' ä¸ªå…³å¡');
        renderLevelList();
      }else{
        alert('JSON æ ¼å¼ä¸æ­£ç¡®ï¼šéœ€è¦æ•°ç»„');
      }
    }catch(err){ alert('è§£æå¤±è´¥ï¼š'+err) }
  };
  reader.readAsText(f);
};

previewRunBtn.onclick = async ()=>{
  // preview runs starter + tests (no save)
  const starter = editStarter.value || '';
  const tests = editTests.value || '';
  previewOutputEl.textContent = '';
  // run starter
  await runPreview(starter, previewOutputEl, true);
  // run tests with _output injection
  const outText = previewOutputEl.textContent;
  const testsScript = `_output = """${escapeForTriple(outText)}"""\n` + tests;
  await runPreview(testsScript, previewOutputEl, false);
};
previewResetBtn.onclick = ()=>{ previewOutputEl.textContent = ''; };

async function runPreview(code, outEl, clear=true){
  const oldOut = outputEl;
  // temporarily redirect outf
  function tmpOutf(text){ outEl.textContent += text; }
  Sk.configure({output:tmpOutf, read:builtinRead});
  try{
    await Sk.misceval.asyncToPromise(function() {
      return Sk.importMainWithBody("<preview>", false, code, true);
    });
  }catch(e){
    outEl.textContent += '\n[Error] ' + e.toString();
  }
}

/* ====== Export progress ====== */
exportProgressBtn.onclick = ()=>{
  if(!state.user){ alert('è¯·å…ˆç™»å½•ç”¨æˆ·åä»¥å¯¼å‡ºè¿›åº¦'); return; }
  const data = {user: state.user, progress: state.progress, exportedAt: Date.now()};
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`bugmaze_progress_${state.user}.json`; a.click();
  URL.revokeObjectURL(url);
};

/* ====== Helpers & init ====== */
function builtinRead(x){
  if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
      throw "File not found: '" + x + "'";
  return Sk.builtinFiles["files"][x];
}

function init(){
  initEditor();
  renderLevelList();
  // load default first level
  if(levels.length) loadLevel(levels[0].id);

  // try to restore last user from localStorage (pick first matching key)
  // We look for last used username in localStorage under a reserved key
  const lastUser = localStorage.getItem(STORAGE_PREFIX + 'last_user');
  if(lastUser){
    usernameEl.value = lastUser;
    saveUserBtn.click();
  }

  // wire up some buttons
  importLevelsBtn.onclick = ()=> importFileInput.click();
  importFileInput.onchange = importLevelsInputHandler;
  clearStorageBtn.onclick = clearAllStorageConfirm;
}
function importLevelsInputHandler(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    try{
      const parsed = JSON.parse(ev.target.result);
      if(Array.isArray(parsed)){
        parsed.forEach(item=>{
          if(!item.id) item.id = 'imp_' + Date.now().toString(36);
          levels.push(item);
        });
        alert('å·²å¯¼å…¥ '+ parsed.length + ' ä¸ªå…³å¡');
        renderLevelList();
      }else alert('æ ¼å¼é”™è¯¯ï¼šéœ€è¦æ•°ç»„');
    }catch(err){ alert(err) }
  };
  r.readAsText(f);
}
function clearAllStorageConfirm(){
  if(!confirm('ç¡®è®¤æ¸…é™¤æœ¬åœ°æ‰€æœ‰ Bug Maze æ•°æ®ï¼ˆåŒ…æ‹¬ç”¨æˆ·å­˜æ¡£ä¸å…³å¡ï¼‰ï¼Ÿ')) return;
  Object.keys(localStorage).forEach(k=>{ if(k.indexOf(STORAGE_PREFIX)===0) localStorage.removeItem(k); });
  alert('æ¸…é™¤æˆåŠŸï¼Œé¡µé¢å°†é‡è½½');
  location.reload();
}

/* ====== Utilities ====== */
// escape triple strings already defined earlier
function escapeForTriple(s){
  if(!s) return '';
  return s.replace(/\\/g,'\\\\').replace(/"""/g,'\\"""');
}

/* ====== Kickoff ====== */
init();
renderLevelList();

/* ====== Extra: allow clicking level in editor modal to populate fields ====== */
levelListEl.addEventListener('click', (e)=>{
  const el = e.target.closest('.level-item');
  if(!el) return;
  // find index by title match (quick)
  const title = el.querySelector('div').innerText.trim().split('\n')[0];
  const lvl = levels.find(x=>x.title===title);
  if(lvl && !levelEditorModal.classList.contains('hidden')){
    // open in editor fields
    state.currentLevelId = lvl.id;
    populateEditorFields(lvl);
  }
});

// Save last used username to a helper key
saveUserBtn.addEventListener('click', ()=>{
  if(usernameEl.value && usernameEl.value.trim()) localStorage.setItem(STORAGE_PREFIX + 'last_user', usernameEl.value.trim());
});

/* ====== End ====== */
</script>
</body>
</html>
